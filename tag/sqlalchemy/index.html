<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" class="h-full" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D,%22class%22:%7B%22ssr%22:%22h-full%22%7D%7D">
  <head>
    <title>Posts tagged &quot;sqlalchemy&quot; | Ana Rute</title><meta name="gridsome:hash" content="4f7e495cf579bdf3a8f4c48806d06b43e7b94c7b"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="Browse posts tagged &quot;sqlalchemy&quot;"><meta data-vue-tag="ssr" property="og:type" content="website"><meta data-vue-tag="ssr" property="og:title" content="Posts tagged &quot;sqlalchemy&quot;"><meta data-vue-tag="ssr" property="og:description" content="Browse posts tagged &quot;sqlalchemy&quot;"><meta data-vue-tag="ssr" property="og:url" content="https://anarute.com//tag/sqlalchemy//"><meta data-vue-tag="ssr" property="og:image" content="https://anarute.com/images/card.png"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:title" content="Posts tagged &quot;sqlalchemy&quot;"><meta data-vue-tag="ssr" name="twitter:description" content="Browse posts tagged &quot;sqlalchemy&quot;"><meta data-vue-tag="ssr" name="twitter:site" content="@ana_rute"><meta data-vue-tag="ssr" name="twitter:creator" content="@ana_rute"><meta data-vue-tag="ssr" name="twitter:image" content="https://anarute.com/images/card.png"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.1dbd3df5a133ad4bfceee6f845dec19f.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.1dbd3df5a133ad4bfceee6f845dec19f.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.1dbd3df5a133ad4bfceee6f845dec19f.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.1dbd3df5a133ad4bfceee6f845dec19f.png"><link data-vue-tag="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:400,700%7CCardo"><link rel="preload" href="/assets/css/10.styles.71c6ed44.css" as="style"><link rel="preload" href="/assets/js/app.b9c80bf7.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--tag-vue.7b7d9ef0.js" as="script"><link rel="prefetch" href="/assets/js/12.bf723347.js"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.2347d897.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.99b74215.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.5f126c02.js"><link rel="prefetch" href="/assets/js/page--src--pages--talks-vue.5513b98e.js"><link rel="prefetch" href="/assets/js/page--src--pages--uses-vue.c5f56cc6.js"><link rel="prefetch" href="/assets/js/page--src--templates--author-vue.f0357935.js"><link rel="prefetch" href="/assets/js/page--src--templates--post-vue.c0a25600.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--index-vue~page--src--templates--author-vue~page--src--templates--post-vue~~a0fae544.81352eac.js"><link rel="prefetch" href="/assets/js/vendors~page--src--templates--post-vue.53a53220.js"><link rel="stylesheet" href="/assets/css/10.styles.71c6ed44.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body class="antialiased font-serif" data-vue-tag="%7B%22class%22:%7B%22ssr%22:%22antialiased%20font-serif%22%7D%7D">
    <div data-server-rendered="true" id="app" class="layout"><section class="menu"><div><nav><ul><li><a href="/" class="active">posts</a></li><li><a href="/about/">about</a></li><li><a href="/uses/">setup</a></li><li><a href="/talks/">talks</a></li><li><a href="/feed.xml">RSS Feed</a></li></ul></nav></div></section><main><header><div><h1>&gt; sqlalchemy</h1><p>1 posts in total</p></div></header><section><article><div><div><header><p class="post-title"><time datetime="2020-07-25 10:00:00">2020-07-25</time>
          -
          <a href="/minha-saga-com-pytest-e-sqlalchemy/">Minha saga com pytest e SQLAlchemy em uma aplicação FastAPI</a></p></header></div></div></article></section><!----></main></div>
    <script>window.__INITIAL_STATE__={"data":{"tag":{"id":"sqlalchemy","title":"sqlalchemy","path":"\u002Ftag\u002Fsqlalchemy\u002F","belongsTo":{"totalCount":1,"pageInfo":{"totalPages":1,"currentPage":1},"edges":[{"node":{"id":"4761b34ad1a7c2ceb12101e3d2a606eb","title":"Minha saga com pytest e SQLAlchemy em uma aplicação FastAPI","datetime":"2020-07-25 10:00:00","path":"\u002Fminha-saga-com-pytest-e-sqlalchemy\u002F","content":"\u003Cp\u003E\u003Cstrong\u003ETLDR:\u003C\u002Fstrong\u003E meu causo sobre aprender \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest\u003C\u002Fcode\u003E na marra. Os primeiros parágrafos são\nintrodutórios, se quiser pular pra parte técnica pode ir direto pro \u003Cstrong\u003EPerrengue 1\u003C\u002Fstrong\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003EDesde que voltei a trabalhar full-time como desenvolvedora (há uns 3 anos), tive\nque reaprender muita coisa e não posso mais me dar ao luxo de continuar com\nalguns gaps teóricos importantes de computação, já que hoje ocupo uma\nposição de tech lead e por estar em um time pequeno, preciso pensar em\narquiteturas de ponta a ponta em stacks diferentes e pra mim o mais difícil:\ndo zero. Decidi então seguir a onda de aprender em público e começa a escrever\nsobre meus aprendizados, quem sabe não ajuda mais alguém que passe pelo mesmo caminho.\u003C\u002Fp\u003E\n\u003Cp\u003EEm quase todos os meus trabalhos passados eu sempre entrei em projetos existentes\no que torna muito mais fácil desenvolver novas features, já que temos no próprio\nrepositório exemplos de como fazer algo. Mas e quando precisamos escolher\ntodas as ferramentas e configurar tudo do início? As vezes pode ser um trabalho\nbem sofrido e moroso. É por isso que ferramentas como \u003Ca href=\"https:\u002F\u002Freactjs.org\u002Fdocs\u002Fcreate-a-new-react-app.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ECreate\nReact App\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fwww.djangoproject.com\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EDjango\u003C\u002Fa\u003E, e \u003Ca href=\"https:\u002F\u002Ffastapi.tiangolo.com\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EFastAPI\u003C\u002Fa\u003E (minha favorita da vez) fazem tanto sucesso.\u003C\u002Fp\u003E\n\u003Cp\u003EEstou trabalhando em uma API RESTFul criada com o FastAPI. Conseguimos portar uma\nAPI feita em Flask pra FastAPI em apenas ~2 semanas em duas pessoas (!), nada contra Flask, mas por ser tão minimalista, ter que configurar coisas como documentação com especificação OpenAPI, um bom suporte pra gestão do banco de dados e concorrencia estava tomando tempo e exigindo um bom tempo de estudo pra fazer uma trabalho bem feito. E foi nisso que o FastAPI nos conquistou! Ele entrega tudo isso de fábrica.\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003EDisclaimer\u003C\u002Fstrong\u003E: acho super importante gastar tempo aprendendo pra fazer algo bem\npensado, mas a gente sabe que no dia a dia do trabalho a realidade é outra, né? na maior parte das vezes, independente da cultura da sua empresa, o tempo de estudo é limitado e precisamos entregar o que foi pedido num certo período de tempo.\u003C\u002Fp\u003E\n\u003Cp\u003EComecei então a configurar os testes. Quando o projeto foi feito em Flask tinha\npouquissima cobertura e a configuração do \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest\u003C\u002Fcode\u003E não estava muito legal então\nresolvi jogar essa parte fora e começar o setup dos testes do zero.\u003C\u002Fp\u003E\n\u003Cp\u003EEu adoro criar testes mas até então só tinha mexido na parte de escrever os casos\nde teste mesmo então sempre começava já com ctrl+c, ctrl+v de um teste existente e adaptava pro caso que queria. Também não tinha experiência com \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest\u003C\u002Fcode\u003E ainda.\u003C\u002Fp\u003E\n\u003Cp\u003EVendo a documentação do FastAPI, rodar testes com \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest\u003C\u002Fcode\u003E no projeto é bem trivial, usei o exemplo padrão e funcionou de primeira, achei que tivesse pronta pra escrever os casos. O projeto usa SQLAlchemy com mysql pra produção e pros testes optei\npor sqlite.\u003C\u002Fp\u003E\n\u003Cp\u003EMas aí é quando as dificuldades começam, quando precisamos adaptar pro nosso cenário.\nMinhas necessidades eram:\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EIniciar os testes com a banco populado com alguns registros\u003C\u002Fli\u003E\n\u003Cli\u003EO banco precisa ser limpo e populado com os valores iniciais a cada teste, pra\nque nenhum teste interfira no outro\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003EAchei que seria simples e acharia muitos exemplos por aí, mas conseguir o que\nqueria me custou muitas horas a mais do que eu esperava.\u003C\u002Fp\u003E\n\u003Ch2 id=\"perrengue-1-entendendo-como-isolar-os-ambientes\"\u003E\u003Ca href=\"#perrengue-1-entendendo-como-isolar-os-ambientes\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EPerrengue 1 (entendendo como isolar os ambientes)\u003C\u002Fh2\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003EAo rodar os testes em um ambiente limpo (no gitlab CI), dava erro por não\nconseguir se conectar ao banco.\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cp\u003EPrimeiro, por que que ao rodar os testes ele tenta acessar o banco configurado no\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E.env\u003C\u002Fcode\u003E se eu configuro o sqlite espeficamente pros testes? e segundo, porque local funciona e no docker do CI não?\u003C\u002Fp\u003E\n\u003Cp\u003EPela documentaçao do FastAPI, eles recomendam usar o \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Ecreate_all\u003C\u002Fcode\u003E do SQLAlchemy\npara criar todas as tabelas \u003Ca href=\"https:\u002F\u002Ffastapi.tiangolo.com\u002Ftutorial\u002Fsql-databases\u002F#create-the-database-tables\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Eantes de iniciar a aplicação\u003C\u002Fa\u003E. O problema é que fazer\nexatamente assim faz com que o \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Ecreate_all\u003C\u002Fcode\u003E seja chamado, só pelo fato de importar o app pros testes. Então a solução foi isolar\no \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Ecreate_all\u003C\u002Fcode\u003E de modo que ele fosse chamado apenas ao rodar a aplicação real, e\nnão com os testes. Isso também explica porque local funcionava e no CI não: local\neu tinha as variaveis de ambiente configuradas corretamente então a conexão com\no banco era bem sucedida mesmo que pros testes fosse usado um banco sqlite.\u003C\u002Fp\u003E\n\u003Ch2 id=\"perrengue-2-entendendo-pytestfixture\"\u003E\u003Ca href=\"#perrengue-2-entendendo-pytestfixture\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EPerrengue 2 (entendendo pytest.fixture)\u003C\u002Fh2\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003ENão consigo conectar ao banco dentro de uma pytest.fixture\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cp\u003EEu sou super defensora de ler a documentação e li e reli a documentação do\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest.fixture\u003C\u002Fcode\u003E umas 5 vezes pra entender o que eu tinha feito errado. Mas às\nvezes mesmo lendo a documentação, se a gente não tem ideia do que está\nacontencedo a doc simplesmente não faz sentido, pelo menos acontece muito comigo,\neu leio as palavras mas nada acontece na minha cabeça, não absorvo o sentido.\nEntão o que percebi que funciona pra mim é um mix de brute force com documentação:\nlê a doc, experimenta um parâmetro ou propriedade diferente, testa e vê o que acontece, repete até entender.\u003C\u002Fp\u003E\n\u003Cp\u003EBaseada na doc do FastAPI, eu tentei usar a mesma função pra conectar ao banco que a aplicação usava, que é algo assim:\u003C\u002Fp\u003E\n\u003Cpre class=\"shiki\" style=\"background-color: #ffffff\"\u003E\u003Ccode\u003E\u003Cspan style=\"color: #D32F2F\"\u003Edef\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Eget_db\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E():\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Etry\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E:\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E        db \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003ETestingSessionLocal()\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6A737D\"\u003E# sessão criada com sessionmaker do SQLAlchemy\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E        \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Eyield\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E db\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Efinally\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E:\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E        db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Eclose()\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EEu tentei fazer com que isso fosse uma fixture com o parametro \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eautouse=True\u003C\u002Fcode\u003E\npra que fosse chamada dentro de cada teste e assim eu poder usar o banco como \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Edb\u003C\u002Fcode\u003E\npra importar os dados que eu queria e inserir o registros iniciais. Mas ao usar\nassim recebia o erro: \u003C\u002Fp\u003E\n\u003Ccode class=\"shiki\" style=\"background: #2e3440; color: #d8dee9\"\u003Eyield_fixture function has more than one &#039;yield&#039;\u003C\u002Fcode\u003E\n\u003Cp\u003EHmm.. os links que o erro sugere na doc explicam bem sobre o erro acima, mas o que será uma \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eyield_fixture\u003C\u002Fcode\u003E? e foi essa dúvida que fez as mil vezes que li\na documentação fazer algum sentido! Basicamente entendi que a \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest.fixture\u003C\u002Fcode\u003E funciona como\num \"envelope\" ao redor do teste, seguindo o seguinte padrão:\u003C\u002Fp\u003E\n\u003Cpre class=\"shiki\" style=\"background-color: #ffffff\"\u003E\u003Ccode\u003E\u003Cspan style=\"color: #6F42C1\"\u003E@pytest.fixture\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #D32F2F\"\u003Edef\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E minha_fixture:\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6A737D\"\u003E# insira qualquer lógica pra ser executada ANTES do teste\u003C\u002Fspan\u003E\n\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Eyield\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E  \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6A737D\"\u003E# (!!) é esse yield que vai retornar o teste e faze-lo rodar\u003C\u002Fspan\u003E\n\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6A737D\"\u003E# insira a lógica de tear down, pra ser executada DEPOIS do test\u003C\u002Fspan\u003E\n\n\u003Cspan style=\"color: #D32F2F\"\u003Edef\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Etest_case_xis\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E(\u003C\u002Fspan\u003E\u003Cspan style=\"color: #FF9800\"\u003Eminha_fixture\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E):\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Eassert\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E a \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E==\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E b\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EEntão a \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest.fixture\u003C\u002Fcode\u003E realmente era o que eu precisava.\u003C\u002Fp\u003E\n\u003Cp\u003EQuando eu chamava o \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eyield db\u003C\u002Fcode\u003E lá em cima no \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eget_db\u003C\u002Fcode\u003E, o \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest\u003C\u002Fcode\u003E tentava\nrodar o teste e nunca chegaria no segundo \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eyield\u003C\u002Fcode\u003E que roda o teste de fato,\nentão o que eu gostaria que acontecesse no setup não tava acontecendo.\u003C\u002Fp\u003E\n\u003Cp\u003EA solução foi bem simples, eu não precisava de uma função pra acessar o banco, bastava rodar \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Edb = TestingSessionLocal()\u003C\u002Fcode\u003E onde esse \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003ETestingSessionLocal\u003C\u002Fcode\u003E é uma sessão criada pelo SQLAlchemy e no tear down do teste, dar um \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Edb.close()\u003C\u002Fcode\u003E. Isso resolveu meu caso\nde acessar o banco, limpa-lo e inserir os dados falsos antes de cada teste.\nFicou algo assim:\u003C\u002Fp\u003E\n\u003Cpre class=\"shiki\" style=\"background-color: #ffffff\"\u003E\u003Ccode\u003E\u003Cspan style=\"color: #6F42C1\"\u003E@pytest.fixture\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E(\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Eautouse\u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #1976D2\"\u003ETrue\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #D32F2F\"\u003Edef\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Einit_db\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E():\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003ETestingSessionLocal()\u003C\u002Fspan\u003E\n\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6A737D\"\u003E# Clean up tables before importing the initial data\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Equery(MyModel)\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Edelete()\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Ecommit()\u003C\u002Fspan\u003E\n\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6A737D\"\u003E# Insert mock data in the db\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Efor\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E r \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Ein\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E fake_records:\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E        new_record \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003EMyModel(\u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E**\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Er)\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E        db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Eadd(new_record)\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E        db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Ecommit()\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E        db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Erefresh(new_record)\u003C\u002Fspan\u003E\n\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Eyield\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6A737D\"\u003E# run the test\u003C\u002Fspan\u003E\n\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Eclose()\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6A737D\"\u003E# close session after running the test\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"perrengue-3-entendendo-como-funcionam-os-models-do-sqlalchemy\"\u003E\u003Ca href=\"#perrengue-3-entendendo-como-funcionam-os-models-do-sqlalchemy\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EPerrengue 3 (entendendo como funcionam os models do SQLAlchemy)\u003C\u002Fh2\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003EConsegui popular o banco antes de um teste, fui replicar o mesmo teste e no\nsegundo caso os valores do primeiro teste ainda estavam no banco\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cp\u003EDepois de finalmente entender como \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epytest.fixture\u003C\u002Fcode\u003E funciona, comecei a ter problemas ao inserir mais casos de teste. Usando nosso amigo \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eprint\u003C\u002Fcode\u003E a impressão que dava era que a fixture só era acessada no primeiro caso. Isso me levou a pesquisar sobre\ncache de fixture, como que as fixtures era chamadas, etc, sem sucesso.\u003C\u002Fp\u003E\n\u003Cp\u003EUsando \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Epdb\u003C\u002Fcode\u003E eu consegui confirmar que a fixture estava sendo chamada a cada teste, então por que raios o banco não estava sendo limpo?\u003C\u002Fp\u003E\n\u003Cp\u003EFoi aí que comecei a desconfiar que o problema não era mais a fixture e precisei entender melhor como o SQLAlchemy lida com sessões\ne gerencia o banco em tempo de execução. Recomendo \u003Ca href=\"https:\u002F\u002Fwww.michaelcho.me\u002Farticle\u002Fsqlalchemy-commit-flush-expire-refresh-merge-whats-the-difference\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Eesse artigo\u003C\u002Fa\u003E sobre isso.\u003C\u002Fp\u003E\n\u003Cp\u003EPra inserir os dados fakes, eu criei um array com meus models já usando o model\nda aplicação, algo como:\u003C\u002Fp\u003E\n\u003Cpre class=\"shiki\" style=\"background-color: #ffffff\"\u003E\u003Ccode\u003E\u003Cspan style=\"color: #24292EFF\"\u003Eusers \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E [\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003EMyModel(id\u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #1976D2\"\u003E1\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003E, name\u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #22863A\"\u003E\"ABC\"\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003E)\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E,\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003EMyModel(id\u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #1976D2\"\u003E2\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003E, name\u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #22863A\"\u003E\"XYZ\"\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003E)\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E,\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E]\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EE na minha fixture:\u003C\u002Fp\u003E\n\u003Cpre class=\"shiki\" style=\"background-color: #ffffff\"\u003E\u003Ccode\u003E\u003Cspan style=\"color: #D32F2F\"\u003Efor\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E user \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Ein\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E users:\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Eadd(user)\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Ecommit()\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Erefresh(user)\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EO primeiro teste a ser rodado SEMPRE dava certo, mas do segundo em diante não.\nEu não conseguia entender o que estava fazendo de errado até tentar entender como\no meu model estava sendo criado: o \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003EMyModel\u003C\u002Fcode\u003E é uma classe que herda o Base da aplicação que no fundo é um \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Edeclarative_base\u003C\u002Fcode\u003E do SQLAlchemy. Ah-há! eu\nachava que eu estava só declarando um array de objetos do tipo MyModel, mas na\nverdade ao criar esse array o SQLAlchemy já estava instanciando esses objetos\ncomo parte dos dados da sessão aberta mesmo que eles não tivessem sido inseridos no banco!\u003C\u002Fp\u003E\n\u003Cp\u003EEntão ao rodar esse \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Efor\u003C\u002Fcode\u003E mais de uma vez o SQLAlchemy reclamava porque o objeto já tinha sido inserido em algum momento então ele não inseria de novo, por isso eu lidava com erros como:\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003EObject already attached to session\u003C\u002Fcode\u003E ou \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Esqlalchemy.exc.InvalidRequestError: Could not refresh instance\u003C\u002Fcode\u003E. Tudo porque eu estava tentando inserir um objeto que ja tinha sido\ninserido no banco E já tinha sido deletado, porque eu deleto tudo antes de rodar os testes, lembra?\u003C\u002Fp\u003E\n\u003Cp\u003EDepois de entender tudo isso fez sentido, eu não preciso ter um array de models reais\npra meus dados falsos antes de criá-los, eu posso ter um array de dicts e na hora de inserir no banco que crio o objeto de verdade, então por fim a solução foi:\u003C\u002Fp\u003E\n\u003Cpre class=\"shiki\" style=\"background-color: #ffffff\"\u003E\u003Ccode\u003E\u003Cspan style=\"color: #24292EFF\"\u003Eusers \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E [\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    {\u003C\u002Fspan\u003E\u003Cspan style=\"color: #22863A\"\u003E\"id\"\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E:\u003C\u002Fspan\u003E\u003Cspan style=\"color: #1976D2\"\u003E1\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E, \u003C\u002Fspan\u003E\u003Cspan style=\"color: #22863A\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E:\u003C\u002Fspan\u003E\u003Cspan style=\"color: #22863A\"\u003E\"ABC\"\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E},\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    {\u003C\u002Fspan\u003E\u003Cspan style=\"color: #22863A\"\u003E\"id\"\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E:\u003C\u002Fspan\u003E\u003Cspan style=\"color: #1976D2\"\u003E1\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E, \u003C\u002Fspan\u003E\u003Cspan style=\"color: #22863A\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E:\u003C\u002Fspan\u003E\u003Cspan style=\"color: #22863A\"\u003E\"XYZ\"\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E},\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E]\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EE na minha fixture:\u003C\u002Fp\u003E\n\u003Cpre class=\"shiki\" style=\"background-color: #ffffff\"\u003E\u003Ccode\u003E\u003Cspan style=\"color: #D32F2F\"\u003Efor\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E user \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003Ein\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E users:\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    new_user \u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E=\u003C\u002Fspan\u003E\u003Cspan style=\"color: #24292EFF\"\u003E \u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003EMyModel(\u003C\u002Fspan\u003E\u003Cspan style=\"color: #D32F2F\"\u003E**\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Euser)\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Eadd(new_user)\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Ecommit()\u003C\u002Fspan\u003E\n\u003Cspan style=\"color: #24292EFF\"\u003E    db.\u003C\u002Fspan\u003E\u003Cspan style=\"color: #6F42C1\"\u003Erefresh(new_user)\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EPronto, agora sim posso ter mil testes todos isolados com o banco limpo e dados\ninciais antes de rodar :)\u003C\u002Fp\u003E\n\u003Ch2 id=\"conclusão\"\u003E\u003Ca href=\"#conclus%C3%A3o\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EConclusão\u003C\u002Fh2\u003E\n\u003Cp\u003EFicar na superfície pode cobrir a maior parte dos casos, mas assim que precisamos de algo que foge do básico ou da configuração que \"vem pronta\" (mesmo que não seja nada extraordinário, como foi meu caso), não tem stackoverflow que salve e precisamos entender de fato o que está acontecendo por baixo dos panos. Pra mim o combo ler documentação + um bom tempo com debug e experimentação é a melhor forma de aprender.\u003C\u002Fp\u003E\n\u003Cp\u003EAgora posso finalemente focar em escrever os testes de fato e garantir que minha aplicação funciona como esperado.\u003C\u002Fp\u003E\n\u003Chr\u003E\n\u003Cp\u003ESe eu falei alguma bobeira ou você sabe uma forma melhor de solucionar os casos\nque mencionei no post, deixa seu comentário aí embaixo ;)\u003C\u002Fp\u003E\n","excerpt":"","description":"","author":{"id":"anarute","title":"anarute","path":"\u002Fauthor\u002Fanarute\u002F"}}}]}}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.b9c80bf7.js" defer></script><script src="/assets/js/page--src--templates--tag-vue.7b7d9ef0.js" defer></script>
  </body>
</html>
