<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" class="h-full" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D,%22class%22:%7B%22ssr%22:%22h-full%22%7D%7D">
  <head>
    <title>Posts tagged &quot;fedora&quot; | Ana Rute</title><meta name="gridsome:hash" content="752c6ce69aa6bc2761e11346ad248f842b46c834"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="Browse posts tagged &quot;fedora&quot;"><meta data-vue-tag="ssr" property="og:type" content="website"><meta data-vue-tag="ssr" property="og:title" content="Posts tagged &quot;fedora&quot;"><meta data-vue-tag="ssr" property="og:description" content="Browse posts tagged &quot;fedora&quot;"><meta data-vue-tag="ssr" property="og:url" content="https://anarute.com//tag/fedora//"><meta data-vue-tag="ssr" property="og:image" content="https://anarute.com/images/card.png"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:title" content="Posts tagged &quot;fedora&quot;"><meta data-vue-tag="ssr" name="twitter:description" content="Browse posts tagged &quot;fedora&quot;"><meta data-vue-tag="ssr" name="twitter:site" content="@ana_rute"><meta data-vue-tag="ssr" name="twitter:creator" content="@ana_rute"><meta data-vue-tag="ssr" name="twitter:image" content="https://anarute.com/images/card.png"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.1dbd3df5a133ad4bfceee6f845dec19f.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.1dbd3df5a133ad4bfceee6f845dec19f.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.1dbd3df5a133ad4bfceee6f845dec19f.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.1dbd3df5a133ad4bfceee6f845dec19f.png"><link data-vue-tag="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:400,700%7CCardo"><link rel="preload" href="/assets/css/10.styles.71c6ed44.css" as="style"><link rel="preload" href="/assets/js/app.0aaf7b86.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--tag-vue.18e80999.js" as="script"><link rel="prefetch" href="/assets/js/12.bf723347.js"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.f874ac3a.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.d8cccfac.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.c4d60db6.js"><link rel="prefetch" href="/assets/js/page--src--pages--talks-vue.fb1d0092.js"><link rel="prefetch" href="/assets/js/page--src--pages--uses-vue.3f17494c.js"><link rel="prefetch" href="/assets/js/page--src--templates--author-vue.4fa776a2.js"><link rel="prefetch" href="/assets/js/page--src--templates--post-vue.910010bc.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--index-vue~page--src--templates--author-vue~page--src--templates--post-vue~~a0fae544.81352eac.js"><link rel="prefetch" href="/assets/js/vendors~page--src--templates--post-vue.989aa289.js"><link rel="stylesheet" href="/assets/css/10.styles.71c6ed44.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body class="antialiased font-serif" data-vue-tag="%7B%22class%22:%7B%22ssr%22:%22antialiased%20font-serif%22%7D%7D">
    <div data-server-rendered="true" id="app" class="layout"><section class="menu"><div><nav><ul><li><a href="/" class="active">posts</a></li><li><a href="/about/">about</a></li><li><a href="/uses/">setup</a></li><li><a href="/talks/">talks</a></li><li><a href="/feed.xml">RSS Feed</a></li></ul></nav></div></section><main><header><div><h1>&gt; fedora</h1><p>1 posts in total</p></div></header><section><article><div><div><header><p class="post-title"><time datetime="2023-08-14 10:00:00">2023-08-14</time>
          -
          <a href="/docker-compose-sem-root-live-reload/">Rodando docker compose sem root e containers com live-reload no Fedora</a></p></header></div></div></article></section><!----></main></div>
    <script>window.__INITIAL_STATE__={"data":{"tag":{"id":"fedora","title":"fedora","path":"\u002Ftag\u002Ffedora\u002F","belongsTo":{"totalCount":1,"pageInfo":{"totalPages":1,"currentPage":1},"edges":[{"node":{"id":"233e353d5ce5d8b3e281b4571f0b2e5d","title":"Rodando docker compose sem root e containers com live-reload no Fedora","datetime":"2023-08-14 10:00:00","path":"\u002Fdocker-compose-sem-root-live-reload\u002F","content":"\u003Cp\u003ENos últimos dias precisei dockerizar uma aplicação divida em 3 serviços:\nmonolito legado, novo front end em React e nova API com FastAPI. Com a chegada\nde uma nova pessoa no time, resolvemos criar um docker-compose que rodasse todas\nas aplicações juntas, incluindo o banco de dados e aplicação de autenticação, o\nque facilitaria bastante o fluxo de desenvolvimento por não ter que configurar\nmanualmente todas as aplicações nem ter que subir uma por uma toda vez.\u003C\u002Fp\u003E\n\u003Cp\u003EMeu principal requisito era criar um docker-compose de modo que os serviços\nfossem atualizados automaticamente sem precisar buildar o container a cada\nmudança, vulgo \u003Cstrong\u003Elive-reload\u003C\u002Fstrong\u003E. O método que escolhi pra fazer isso foi com\nvolumes, já que pareceu a opção mais natural: docker espelha os arquivos de uma\npasta local com os arquivos do ambiente docker, assim qualquer modificação nos\nvolumes serão compartilhadas com os containers sem a necessidade de\nreconstruir-los.\u003C\u002Fp\u003E\n\u003Cp\u003EComo um teste simples inicial, criei uma aplicação com FastAPI, com um único\nendpoint o mais simples possível:\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E# src\u002Fmain.py\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Efrom typing import Optional\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Efrom fastapi import FastAPI\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eapp = FastAPI()\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E@app.get(&quot;\u002F&quot;)\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Edef read_root():\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Ereturn {&quot;Hello&quot;: &quot;World&quot;}\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003EO Dockerfile também super simples, seguindo os passos da \u003Ca href=\"https:\u002F\u002Ffastapi.tiangolo.com\u002Fdeployment\u002Fdocker\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Edocumentação do\nFastAPI\u003C\u002Fa\u003E:\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E# Dockerfile\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003EFROM python:3.9\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003EWORKDIR \u002Fcode\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003ECOPY .\u002Frequirements.txt \u002Fcode\u002Frequirements.txt\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003ERUN pip install --no-cache-dir --upgrade -r \u002Fcode\u002Frequirements.txt\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003ECOPY .\u002Fapp \u002Fcode\u002Fapp\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003EEXPOSE 8000\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E# A opção --reload é que faz o servidor recarregar quando há mudanças nos arquivos\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003ECMD [&quot;uvicorn&quot;, &quot;app.main:app&quot;, &quot;--reload&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8000&quot;]\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003EE no docker-compose, o segredo tá na configuração dos volumes:\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E# docker-compose.yml\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eversion: &#039;3.7&#039;\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eservices:\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eserver:\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Econtainer_name: server\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Ebuild:\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Econtext: .\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Edockerfile: Dockerfile\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Evolumes:\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E- .\u002Fapp:\u002Fcode\u002Fapp\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eports:\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E- &quot;8008:8008&quot;\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003EAqui estamos dizendo que a pasta \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eapp\u003C\u002Fcode\u003E, que nesse caso está no mesmo nível do\narquivo \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Edocker-compose.yml\u003C\u002Fcode\u003E vai ser espelhada na pasta \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E\u002Fcode\u002Fapp\u003C\u002Fcode\u003E dentro do\ncontainer. Se você reparar no Dockerfile eu copio a pasta \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E.\u002Fapp\u003C\u002Fcode\u003E para\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003E\u002Fcode\u002Fapp\u003C\u002Fcode\u003E, assim o conteúdo das duas deveria ser o mesmo e é exatamente onde\nestão os arquivos que eu modifico e que gostaria durante o desenvolvimento e que\ngostaria que o servidor recarregasse ao serem modificados.\u003C\u002Fp\u003E\n\u003Cp\u003EA princípio isso deveria funcionar, encontrei vários exemplos que faziam\nexatemente isso e pareciam bem simples, mas por algum motivo não funcionava pra\nmim. Assim que eu configurava o volume, as aplicações não funcionavam mais e\ninvestigando um pouco parecia que os arquivos ou não eram mais copiados para o\ncontainer ou o container não tinha permissão de lê-los.\u003C\u002Fp\u003E\n\u003Cp\u003EComo eu uso Fedora, no lugar Docker eu uso Podman, mas para docker compose usava\no pacote \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Edocker-compose\u003C\u002Fcode\u003E mesmo e tinha que rodar docker-compose com sudo, o que\nnão era exatamente ideal já que uma das melhores vantagens do podman (além de\nser open source) é a possibilidade de rodar docker sem root. Comecei a achar que\no problema deveria estar relacionado a isso, já que tinha cara de problema de\npermissões. Depois de postergar por meses, resolvi finalmente parar pra resolver\nisso e passar a rodar docker-compose sem root. Essa foi a primeira parte da\nsolução, o que eu não contava é que em um artigo só eu acharia a solução para os\ndois problemas: \u003Ca href=\"https:\u002F\u002Fbrandonrozek.com\u002Fblog\u002Frootless-docker-compose-podman\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Ehttps:\u002F\u002Fbrandonrozek.com\u002Fblog\u002Frootless-docker-compose-podman\u002F\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003EA solução veio em duas etapas, passar a rodar o socket do podman como meu\nusuário e não mais com root:\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Esystemctl --user enable podman.socket\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Esystemctl --user start podman.socket\u003C\u002Fcode\u003E\n\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Eexport DOCKER_HOST=unix:\u002F\u002F\u002Frun\u002Fuser\u002F$UID\u002Fpodman\u002Fpodman.sock\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003EE no finalzinho do artigo, Brandon solta essa informação despretenciosamente que\nfoi o que me salvou:\u003C\u002Fp\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003E\"If you want to add to add more volumes to the container, make sure it has the\nappropriate SELinux label if you’re using a distribution with it enabled.\"\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cp\u003E\u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Echcon -t container_file_t -R &lt;volume_name&gt;\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003ENo caso do meu exemplo, \u003Ccode class=\"shiki-inline\" style=\"background: #2e3440; color: #d8dee9\"\u003Echcon -t container_file_t -R app\u003C\u002Fcode\u003E foi o que resolveu.\u003C\u002Fp\u003E\n\u003Cp\u003EEu quebrei muita a cabeça até achar essa solução e finalmente consigo rodar\ndocker-compose sem root e usar live-reload!\u003C\u002Fp\u003E\n\u003Cp\u003ESegue o repositório bem simples com exemplo que descrevi:\n\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fanarute\u002Ffastapi-live-reload\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fanarute\u002Ffastapi-live-reload\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003ESe quiser ler um pouco mais sobre, recomendo \u003Ca href=\"https:\u002F\u002Fwww.freecodecamp.org\u002Fnews\u002Fhow-to-enable-live-reload-on-docker-based-applications\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Eesse\nartigo\u003C\u002Fa\u003E\ndo Erick Wendel.\u003C\u002Fp\u003E\n","excerpt":"","description":"","author":{"id":"anarute","title":"anarute","path":"\u002Fauthor\u002Fanarute\u002F"}}}]}}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.0aaf7b86.js" defer></script><script src="/assets/js/page--src--templates--tag-vue.18e80999.js" defer></script>
  </body>
</html>
